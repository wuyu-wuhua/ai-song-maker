<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Maker Results</title>
    <link rel="stylesheet" href="style.css"> <!-- Link to the main stylesheet -->
    <style>
        /* Add specific styles for results page if needed */
        body {
            /* padding-top: 80px; */ /* Remove this line */
        }
        .results-container {
            max-width: 1100px; /* Increase max-width for side-by-side layout */
            margin: 2rem auto;
            padding: 2rem;
            /* background-color: #1a1a2e; */ /* Container background can be transparent */
            border-radius: 8px;
            /* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); */ /* Remove shadow from main container */
            color: #e0e0e0;
        }
        /* Style the main title */
        .results-container > h1 {
            color: #87CEFA; /* Light blue */
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2rem; /* Adjust size if needed */
        }

        /* Flex container for the columns */
        .results-columns {
            display: flex;
            gap: 2rem; /* Space between columns */
        }

        .result-section {
           /* margin-bottom: 2rem; */ /* Remove margin-bottom for flex items */
           /* padding-bottom: 1.5rem; */ /* Remove padding-bottom */
           /* border-bottom: 1px solid #2c3e50; */ /* Remove bottom border */
            flex: 1; /* Make sections share space equally */
            background-color: #080c18; /* Change background to match body */
            border-radius: 8px; /* Keep border-radius */
            /* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); */ /* Remove shadow */
            padding: 1.5rem; /* Adjust padding if needed */
            /* Add border if needed for separation */
             border: 1px solid #2c3e50; 
        }
        .result-section:last-child {
            /* border-bottom: none; */
            /* margin-bottom: 0; */
            /* padding-bottom: 0; */
        }
        .result-section h2 {
            color: #ffffff;
            margin-bottom: 1rem;
            font-size: 1.6rem;
        }
        .result-section p,
        .result-section pre {
            color: #b0b0c0;
            white-space: pre-wrap; /* Preserve line breaks in lyrics */
            word-wrap: break-word;
            background-color: #2c2c38; /* Slightly different background for pre */
            padding: 1rem;
            border-radius: 5px;
            max-height: 300px; /* Limit height for long lyrics */
            overflow-y: auto; /* Add scroll for long lyrics */
            margin-bottom: 1rem; /* Add margin between paragraphs/pre */
        }

        /* --- Custom Scrollbar for Lyrics Box (WebKit) --- */
        #result-lyrics::-webkit-scrollbar {
            width: 8px; /* Width of the scrollbar */
        }

        #result-lyrics::-webkit-scrollbar-track {
            background: #2c2c38; /* Track background same as pre background */
            border-radius: 5px; /* Optional: round the track */
        }

        #result-lyrics::-webkit-scrollbar-thumb {
            background-color: #555; /* Color of the scroll thumb */
            border-radius: 5px; /* Round the scroll thumb */
            border: 2px solid #2c2c38; /* Creates padding around thumb */
        }

        #result-lyrics::-webkit-scrollbar-thumb:hover {
            background-color: #777; /* Thumb color on hover */
        }
        /* --- End Custom Scrollbar --- */

         .result-section span {
             font-weight: bold;
             color: #ffffff;
         }
        .audio-player-placeholder {
            margin-top: 1rem;
            padding: 2rem;
            background-color: #2c2c38;
            border-radius: 5px;
            text-align: center;
            color: #a0a0b0;
        }
        .back-button {
            display: block; /* Make button block level for centering */
            width: fit-content; /* Button width fits content */
            margin: 2rem auto 0; /* Center button with top margin */
            padding: 0.8rem 2rem;
            background: linear-gradient(to right, #007bff, #0056b3, #007bff);
            background-size: 200% auto;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.2s ease;
            animation: gradientShift 3s linear infinite;
        }
        .back-button:hover {
             transform: scale(1.05);
        }

        /* Responsive stacking */
        @media (max-width: 768px) {
            .results-columns {
                display: block; /* Stack columns */
            }
            .result-section {
                margin-bottom: 2rem; /* Add margin back for stacked view */
                /* Optionally add border-bottom back if needed */
                 border-bottom: 1px solid #2c3e50; 
                 padding-bottom: 1.5rem;
            }
             .result-section:last-of-type {
                 margin-bottom: 0;
                 border-bottom: none;
                 padding-bottom: 1.5rem; /* Keep padding consistent */
             }
        }

    </style>
</head>
<body>
    <!-- Reuse the same header -->
     <header>
        <div class="logo" data-key="logoText">Song Maker</div>
        <nav>
            <div class="language-switcher">
                <button data-lang="en">English</button>
                <button data-lang="zh">中文</button>
            </div>
        </nav>
    </header>

    <main class="results-container">
        <h1>Your AI Generated Song</h1>

        <!-- Wrapper for side-by-side columns -->
        <div class="results-columns">
            <!-- Display User Input -->
            <section class="result-section">
                <h2>Your Input</h2>
                <p><strong>Title:</strong> <span id="result-title"></span></p>
                <p><strong>Style:</strong> <span id="result-style"></span></p>
                <p><strong>Singer:</strong> <span id="result-singer"></span></p>
                <div>
                    <strong>Lyrics:</strong>
                    <pre id="result-lyrics"></pre>
                </div>
            </section>

            <!-- Display AI Song -->
            <section class="result-section">
                <h2>AI Generated Song</h2>
                <div class="audio-player-placeholder">
                    <p>Generating your song... please wait.</p>
                    <!-- Placeholder for actual audio player -->
                    <!-- <audio controls src="path/to/generated/song.mp3"></audio> -->
                </div>
            </section>
        </div> <!-- End of results-columns -->

        <a href="index.html" class="back-button">Generate Another Song</a>

    </main>

    <!-- Link to main JS for language switching, and potentially a new results.js -->
    <script src="script.js"></script>
    <!-- === Start: Script for results page === -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const songDataString = sessionStorage.getItem('songMakerData');
            const resultsContainer = document.querySelector('.results-container');
            const audioPlaceholder = document.querySelector('.audio-player-placeholder');
            const errorElement = document.createElement('p'); // Element to show errors
            errorElement.style.color = 'red';
            errorElement.style.marginTop = '1rem'; // Add some space for the error message

            // --- 先显示用户输入 ---
            if (songDataString) {
                const songData = JSON.parse(songDataString);
                document.getElementById('result-title').textContent = songData.title || 'N/A';
                document.getElementById('result-style').textContent = songData.style || 'N/A';
                document.getElementById('result-singer').textContent = songData.singer || 'N/A';
                document.getElementById('result-lyrics').textContent = songData.lyrics || 'No lyrics provided.';

                // --- 调用你的后端 API (Vercel Serverless Function) ---
                const backendUrl = '/api/generate-song'; // 指向 Vercel 函数路径

                // 清空之前的错误信息，显示加载中
                audioPlaceholder.innerHTML = '<p>Generating your song... please wait. This might take a minute.</p>';

                // *** Fetch call starts here ***
                fetch(backendUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(songData) // 发送用户输入数据
                })
                .then(response => {
                    if (!response.ok) {
                        // 尝试读取 JSON 错误信息
                        return response.json().then(err => {
                             // 将服务器返回的错误信息和状态码一起抛出
                             throw new Error(err.message || `Server responded with status: ${response.status}`);
                        }).catch(() => {
                             // 如果响应体不是 JSON 或为空，抛出通用错误
                             throw new Error(`Server responded with status: ${response.status}`);
                        });
                    }
                    return response.json(); // 解析 JSON 响应体
                })
                .then(data => {
                    // --- 处理成功响应 ---
                    if (data && data.audioData && data.contentType && data.contentType.startsWith('audio/')) {
                        console.log('Base64 Audio Data received. Content-Type:', data.contentType);
                        const audioElement = document.createElement('audio');
                        audioElement.setAttribute('controls', ''); // 添加播放控件
                        audioElement.setAttribute('src', data.audioData); // 使用 Base64 Data URL
                        audioElement.style.width = '100%'; // 让播放器宽度适应容器

                        // 替换占位符内容为播放器
                        audioPlaceholder.innerHTML = ''; // 清空 "Generating..."
                        audioPlaceholder.appendChild(audioElement);

                    } else {
                        // 如果后端返回成功但数据格式不对
                        console.error("Invalid audio data format received:", data);
                        throw new Error('Invalid audio data format from serverless function.');
                    }
                })
                .catch(error => {
                    // --- 处理 fetch 错误或后端返回的错误 ---
                    console.error('Error during song generation:', error);
                    errorElement.textContent = `Error: ${error.message}`; // 显示具体的错误信息
                    audioPlaceholder.innerHTML = ''; // 清空 "Generating..."
                    audioPlaceholder.appendChild(errorElement); // 显示错误信息
                });
                // *** Fetch call ends here ***

            } else {
                // --- 处理 sessionStorage 中没有数据的情况 ---
                resultsContainer.innerHTML = '<h1>Error</h1><p>Could not retrieve song data. Please go back and try again.</p><a href="index.html" class="back-button">Back to Maker</a>';
            }

            // --- 应用翻译 (暂时注释掉) ---
            /*
            const preferredLang = localStorage.getItem('preferredLang') || 'en';
            if (typeof applyTranslations === 'function') {
                applyTranslations(preferredLang);
            } else {
                console.error('applyTranslations function not found.');
            }
            */
        });
    </script>
    <!-- === End: Script for results page === -->
     <footer>

        <p><a href="https://beian.miit.gov.cn" rel="nofollow">渝ICP备2025054340号</a></p>
        <p data-key="contactEmail">Contact: ytsgabcde00020@2925.com</p>
    </footer>
</body>
</html> 